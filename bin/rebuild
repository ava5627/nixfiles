#!/usr/bin/env bash
sudo -v # ask for sudo password up front
set -e # stop on error

pushd ~/nixfiles > /dev/null

# check for untracked files
UNTRACKED=$(git ls-files --others --exclude-standard)
if [ -n "$UNTRACKED" ]; then
    echo "Untracked files:"
    echo "$UNTRACKED"
    exit 1
fi

git -c delta.hunk-header-style="omit" -c delta.side-by-side=false diff -U0

# if args contain --host then use next arg as hostname
if [[ "$*" == *"--host"* ]]; then
    HOST=$(echo "$*" | grep -oP -- "--host \K\S+")
    echo "Building for host: $HOST"
    sudo nixos-rebuild switch --fast --flake .#"$HOST" &> /tmp/nixos-rebuild.log || (cat /tmp/nixos-rebuild.log | grep --color error && false)
else
    echo "Rebuilding NixOS"
    sudo nixos-rebuild switch --fast --flake . &> /tmp/nixos-rebuild.log || (cat /tmp/nixos-rebuild.log | grep --color error && false)
fi

CHANGED_PKGS=$(ls /nix/var/nix/profiles | tail -n 2 | awk '{print "/nix/var/nix/profiles/" $0}' - | xargs nvd --color always diff)
# print the upgraded packages if there are any
if ! echo $CHANGED_PKGS | rg "No version or selection state changes" &> /dev/null; then
    echo "$CHANGED_PKGS" | tail -n +3 | head -n -1
fi

# system-<gen>-link
CURRENT=$(ls /nix/var/nix/profiles | tail -n 1 | cut -d '-' -f 2)

if [ $(git status -s | wc -l) -gt 0 ]; then
    # use the first arg as commit message unless it starts with -
    if [[ "$1" != -* && -n "$1" ]]; then
        COMMIT_MSG=": $1"
    fi
    git commit -am "Nixos $CURRENT$COMMIT_MSG"
fi

popd > /dev/null
echo $CURRENT$COMMIT_MSG
